<script>
  window.onload = function() {
    google.script.run.withSuccessHandler(renderSchema).getInitialSchema();
    initAccordion();
  };

  /**
   * Prevents multiple accordion sections from being open at once
   */
  function initAccordion() {
    const allDetails = document.querySelectorAll('details');
    allDetails.forEach((targetDetail) => {
      const summary = targetDetail.querySelector('summary');
      summary.addEventListener('click', (e) => {
        if (!targetDetail.hasAttribute('open')) {
          allDetails.forEach((otherDetail) => {
            if (otherDetail !== targetDetail) {
              otherDetail.removeAttribute('open');
            }
          });
        }
      });
    });
  }

  /**
   * Renders the initial column list with suggested types
   */
  function renderSchema(schema) {
    const container = document.getElementById('schema-list');
    container.innerHTML = schema.map(col => `
      <div class="schema-item">
        <input type="checkbox" class="schema-check" value="${col.index}" checked>
        <span class="col-name" title="${col.name}">${col.name}</span>
        <select class="schema-type">
          <option value="Numeric" ${col.suggestedType === 'Numeric' ? 'selected' : ''}>Numeric</option>
          <option value="Categorical" ${col.suggestedType === 'Categorical' ? 'selected' : ''}>Categorical</option>
          <option value="Date" ${col.suggestedType === 'Date' ? 'selected' : ''}>Date</option>
        </select>
      </div>
    `).join('');
  }

  /**
   * Triggers the server-side diagnostic
   */
  function runInitialScan() {
    const btn = document.getElementById('scan-btn');
    const status = document.getElementById('scan-status');
    
    // Clear previous error styles
    status.classList.remove('error-pulse');
    
    const selections = Array.from(document.querySelectorAll('.schema-item')).map(item => ({
      index: parseInt(item.querySelector('.schema-check').value),
      type: item.querySelector('.schema-type').value,
      checked: item.querySelector('.schema-check').checked
    })).filter(s => s.checked);

    if (selections.length === 0) return alert("Please select at least one variable.");
    
    btn.disabled = true; 
    btn.innerText = "Scanning...";
    status.innerText = "> Analyzing data integrity...";

    google.script.run.withSuccessHandler(res => {
      btn.disabled = false; 
      btn.innerText = "Re-Scan Selection";
      
      if (res.error) { 
        // 1. Display the specific Error (Row, Column, Value)
        status.innerHTML = `<div style="color: #d93025; font-weight: bold;">⚠️ ${res.error}</div>`;
        status.classList.add('error-pulse');
        
        // 2. Reset modules but KEEP the error message visible
        resetUI(true); 
      } 
      else { 
        status.classList.remove('error-pulse');
        displayScanResults(res); 
      }
    }).performDiagnostic(selections);
  }

  /**
   * Unlocks modules and updates badges based on scan report
   */
  function displayScanResults(res) {
    resetUI(); // Standard reset (clears previous status text)
    
    if (res.hasMissing) unlock('mod-missing', 'list-missing', res.missingCount, res.missingDetails, 'missing');
    
    let totalDateObs = 0;
    if (res.dateDetails) Object.values(res.dateDetails).forEach(c => totalDateObs += c);
    if (totalDateObs > 0) unlock('mod-dates', 'list-dates', totalDateObs, res.dateDetails, 'date');
    
    if (res.hasOutliers) unlock('mod-scaling', 'list-outliers', res.outlierCount, res.outlierDetails, 'scaling');
    
    if (res.hasStrings) {
      unlock('mod-cleanup', 'list-cleanup', res.cleanupCount, res.stringDetails, 'cleanup');
      let totalStr = 0;
      Object.values(res.stringDetails).forEach(c => totalStr += c);
      unlock('mod-encoding', 'list-encoding', totalStr, res.stringDetails, 'encoding');
    }
    
    document.getElementById('scan-status').innerHTML = 
      `<strong>Scan Complete:</strong> Found ${res.totalIssues} potential improvements.`;
  }

  /**
   * Populates module lists and enables UI cards
   */
  function unlock(modId, listId, count, details, type) {
    const mod = document.getElementById(modId);
    if (!mod) return;
    mod.classList.remove('disabled-module');
    
    const badge = mod.querySelector('.badge');
    if (badge) {
      badge.innerText = count;
      badge.classList.add('filled');
    }
    
    let html = '';
    for (const [colName, obsCount] of Object.entries(details)) {
      const schemaItem = Array.from(document.querySelectorAll('.schema-item'))
        .find(i => i.querySelector('.col-name').innerText === colName);
      if (!schemaItem) continue;

      const colIdx = schemaItem.querySelector('.schema-check').value;
      const colType = schemaItem.querySelector('.schema-type').value;
      
      if (type === 'scaling') {
        html += `
          <div class="config-row">
            <div class="config-header">
              <input type="checkbox" class="scaling-check" value="${colIdx}" onchange="toggleFolder(this)">
              <div class="header-text"><strong>${colName}</strong><span class="count-pill">${obsCount} outliers</span></div>
            </div>
            <div class="folder-content" style="display:none;">
              <select class="scaling-method" onchange="validateScalingInputs()">
                <option value="" disabled selected>Select Strategy...</option>
                <option value="Z-SCORE">Z-Score</option>
                <option value="MIN-MAX">Min-Max</option>
                <option value="LOG">Log Transform</option>
                <option value="WINSORIZE">Winsorize</option>
                <option value="DROP">❌ Drop Rows</option>
              </select>
            </div>
          </div>`;
      } else if (type === 'date') {
        html += `
          <div class="config-row">
            <div class="config-header">
              <input type="checkbox" class="date-fix-check" value="${colIdx}" onchange="toggleFolder(this)">
              <div class="header-text"><strong>${colName}</strong><span class="count-pill">${obsCount} items</span></div>
            </div>
            <div class="folder-content" style="display:none;">
              <select class="date-locale" onchange="validateDateInputs()">
                <option value="" disabled selected>Source Locale...</option>
                <option value="US">Month/Day/Year (US)</option>
                <option value="EU">Day/Month/Year (EU)</option>
              </select>
              <select class="date-format" onchange="validateDateInputs()" style="margin-top:5px;">
                <option value="" disabled selected>Target Format...</option>
                <option value="ISO">YYYY-MM-DD</option>
                <option value="US_LONG">Long Form (Month DD, YYYY)</option>
                <option value="UNIX">Unix Timestamp</option>
              </select>
            </div>
          </div>`;
      } else if (type === 'missing') {
        let opts = colType === 'Numeric' 
          ? `<option value="MEAN">Mean</option><option value="MEDIAN">Median</option><option value="ZERO">Zero</option>`
          : `<option value="MODE">Mode</option><option value="LABEL">"Unknown"</option>`;
        opts += `<option value="FORWARD">Forward Fill</option><option value="CUSTOM">Custom Value</option><option value="DROP">❌ Drop Rows</option>`;

        html += `
          <div class="config-row">
            <div class="config-header">
              <input type="checkbox" class="missing-check" value="${colIdx}" onchange="toggleFolder(this)">
              <div class="header-text"><strong>${colName}</strong><span class="count-pill">${obsCount} missing</span></div>
            </div>
            <div class="folder-content" style="display:none;">
              <select class="missing-method" onchange="handleMissingMethodChange(this)">
                <option value="" disabled selected>Impute...</option>
                ${opts}
              </select>
              <input type="text" class="custom-input" style="display:none; margin-top:5px;" placeholder="Custom value...">
            </div>
          </div>`;
      } else if (type === 'cleanup') {
        html += `
          <div class="config-row">
            <div class="config-header">
              <input type="checkbox" class="cleanup-master-check" value="${colIdx}" onchange="toggleFolder(this)">
              <div class="header-text"><strong>${colName}</strong></div>
            </div>
            <div class="folder-content" style="display:none; padding-left: 20px;">
              <label><input type="checkbox" class="clean-trim" checked> Trim White Spaces</label><br>
              <label><input type="checkbox" class="clean-lower"> lowercase</label><br>
              <label><input type="checkbox" class="clean-alpha"> Alpha-Numeric Only</label>
            </div>
          </div>`;
      } else if (type === 'encoding') {
        html += `
          <div class="config-row">
            <div class="config-header">
              <input type="checkbox" class="encoding-check" value="${colIdx}" onchange="handleEncodingSelection(this)">
              <div class="header-text"><strong>${colName}</strong></div>
            </div>
            <div class="folder-content" style="display:none;">
              <select class="encoding-method" onchange="handleEncodingMethodChange(this)">
                <option value="" disabled selected>Encoding...</option>
                <option value="ONE-HOT">One-Hot (Dummies)</option>
                <option value="LABEL">Label (Ordinal)</option>
              </select>
              <div class="ordinal-sort-area" style="display:none; margin-top:10px;">
                <ul class="sortable-list"></ul>
              </div>
            </div>
          </div>`;
      }
    }
    document.getElementById(listId).innerHTML = html;
  }

  /**
   * UI RESET: Prevents overwriting error messages if keepMessage is true
   */
  function resetUI(keepMessage = false) {
    if (!keepMessage) {
      document.getElementById('scan-status').innerHTML = "> Initializing scan...";
      document.getElementById('scan-status').classList.remove('error-pulse');
    }
    
    document.querySelectorAll('.module-card').forEach(mod => {
      mod.classList.add('disabled-module');
      mod.removeAttribute('open');
      const badge = mod.querySelector('.badge');
      if (badge) { badge.innerText = ''; badge.classList.remove('filled'); }
      const container = mod.querySelector('.variable-config-container');
      if (container) container.innerHTML = '';
      const btn = mod.querySelector('.secondary-btn');
      if (btn) btn.disabled = true;
    });
  }

  // --- VALIDATION HELPERS ---
  function toggleFolder(cb) {
    const content = cb.closest('.config-row').querySelector('.folder-content');
    content.style.display = cb.checked ? "block" : "none";
    validateScalingInputs(); validateDateInputs(); validateMissingInputs(); validateCleanupInputs(); validateEncodingInputs();
  }

  function validateScalingInputs() {
    const any = Array.from(document.querySelectorAll('.scaling-check:checked')).some(cb => cb.closest('.config-row').querySelector('.scaling-method').value);
    document.getElementById('scaling-apply-btn').disabled = !any;
  }

  function validateDateInputs() {
    const any = Array.from(document.querySelectorAll('.date-fix-check:checked')).some(cb => {
      const row = cb.closest('.config-row');
      return row.querySelector('.date-locale').value && row.querySelector('.date-format').value;
    });
    document.getElementById('date-apply-btn').disabled = !any;
  }

  function validateMissingInputs() {
    const any = Array.from(document.querySelectorAll('.missing-check:checked')).some(cb => cb.closest('.config-row').querySelector('.missing-method').value);
    document.getElementById('missing-apply-btn').disabled = !any;
  }

  function validateCleanupInputs() {
    const any = document.querySelectorAll('.cleanup-master-check:checked').length > 0;
    document.getElementById('cleanup-apply-btn').disabled = !any;
  }

  function validateEncodingInputs() {
    const any = Array.from(document.querySelectorAll('.encoding-check:checked')).some(cb => cb.closest('.config-row').querySelector('.encoding-method').value);
    document.getElementById('encoding-apply-btn').disabled = !any;
  }

  // --- ACTION HANDLERS ---
  function runDateFix() {
    const btn = document.getElementById('date-apply-btn'), configs = [];
    document.querySelectorAll('.date-fix-check:checked').forEach(cb => {
      const row = cb.closest('.config-row');
      configs.push({ index: parseInt(cb.value), locale: row.querySelector('.date-locale').value, format: row.querySelector('.date-format').value });
    });
    toggleLoading(btn, true, "Processing...");
    google.script.run.withSuccessHandler(msg => refreshAfterFix(btn, msg)).applyDateTransformation(configs);
  }

  function runScalingFix() {
    const btn = document.getElementById('scaling-apply-btn'), configs = [];
    document.querySelectorAll('.scaling-check:checked').forEach(cb => {
      configs.push({ index: parseInt(cb.value), method: cb.closest('.config-row').querySelector('.scaling-method').value });
    });
    toggleLoading(btn, true, "Scaling...");
    google.script.run.withSuccessHandler(msg => refreshAfterFix(btn, msg)).applyScalingTransformation(configs);
  }

  function runMissingFix() {
    const btn = document.getElementById('missing-apply-btn'), configs = [];
    document.querySelectorAll('.missing-check:checked').forEach(cb => {
      const row = cb.closest('.config-row');
      configs.push({ index: parseInt(cb.value), method: row.querySelector('.missing-method').value, customVal: row.querySelector('.custom-input').value });
    });
    toggleLoading(btn, true, "Imputing...");
    google.script.run.withSuccessHandler(msg => refreshAfterFix(btn, msg)).applyMissingTransformation(configs);
  }

  function runCleanupFix() {
    const btn = document.getElementById('cleanup-apply-btn'), configs = [];
    document.querySelectorAll('.cleanup-master-check:checked').forEach(cb => {
      const row = cb.closest('.config-row');
      configs.push({ index: parseInt(cb.value), doTrim: row.querySelector('.clean-trim').checked, doLower: row.querySelector('.clean-lower').checked, doAlphaNum: row.querySelector('.clean-alpha').checked });
    });
    toggleLoading(btn, true, "Cleaning...");
    google.script.run.withSuccessHandler(msg => refreshAfterFix(btn, msg)).applyStructuralCleanup(configs);
  }

  function runEncodingFix() {
    const btn = document.getElementById('encoding-apply-btn'), configs = [];
    document.querySelectorAll('.encoding-check:checked').forEach(cb => {
      const row = cb.closest('.config-row');
      const order = Array.from(row.querySelectorAll('.sort-item input')).map(i => i.value);
      configs.push({ index: parseInt(cb.value), method: row.querySelector('.encoding-method').value, order: order });
    });
    toggleLoading(btn, true, "Encoding...");
    google.script.run.withSuccessHandler(msg => refreshAfterFix(btn, msg)).applyEncodingTransformation(configs);
  }

  function refreshAfterFix(btn, msg) {
    updateLog(msg); 
    resetUI();
    google.script.run.withSuccessHandler(schema => { 
      renderSchema(schema); 
      toggleLoading(btn, false, "Apply"); 
    }).getInitialSchema();
  }

  function handleMissingMethodChange(sel) {
    sel.closest('.folder-content').querySelector('.custom-input').style.display = sel.value === "CUSTOM" ? "block" : "none";
    validateMissingInputs();
  }

  function handleEncodingMethodChange(sel) {
    const row = sel.closest('.config-row');
    const sortArea = row.querySelector('.ordinal-sort-area');
    if (sel.value === "LABEL") {
      sortArea.style.display = "block";
      google.script.run.withSuccessHandler(values => {
        sortArea.querySelector('.sortable-list').innerHTML = values.map(v => `<li class="sort-item"><span class="drag-handle">☰</span> ${v}<input type="hidden" value="${v}"></li>`).join('');
        new Sortable(sortArea.querySelector('.sortable-list'), { animation: 150, handle: '.drag-handle' });
      }).getUniqueValues(row.querySelector('.encoding-check').value);
    } else { sortArea.style.display = "none"; }
    validateEncodingInputs();
  }

  function handleEncodingSelection(cb) { toggleFolder(cb); validateEncodingInputs(); }
  function toggleLoading(b, load, txt) { b.disabled = load; b.innerText = txt; b.style.opacity = load ? "0.5" : "1"; }
  function updateLog(m) { document.getElementById('log-console').innerText = "> " + m; }
  function toggleAllSchema(v) { document.querySelectorAll('.schema-check').forEach(c => c.checked = v); }
</script>
